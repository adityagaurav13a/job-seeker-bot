name: Build & Deploy Bot

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image tag
        run: echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Build & Push Docker Image
        run: |
          docker build -t aditygau/telegram-bot:$IMAGE_TAG .
          docker push aditygau/telegram-bot:$IMAGE_TAG

      - name: Deploy on EC2 via SSH
        uses: appleboy/ssh-action@v1
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Pull the new image
            docker pull aditygau/telegram-bot:$IMAGE_TAG

            # Stop current container (if running) with zero-downtime strategy
            if docker ps -q --filter "name=telegram-bot"; then
              docker rename telegram-bot telegram-bot-old
            fi

            # Run new container
            docker run -d \
              --name telegram-bot \
              -p 8000:8000 \
              -e BOT_TOKEN="$BOT_TOKEN" \
              -e ADMIN_CHAT_ID="$ADMIN_CHAT_ID" \
              -v /home/ec2-user/job-seeker-bot/data:/data \
              aditygau/telegram-bot:$IMAGE_TAG

            # Remove old container after new one is up
            if docker ps -a --filter "name=telegram-bot-old"; then
              docker rm -f telegram-bot-old
            fi